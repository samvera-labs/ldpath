#!/usr/bin/env ruby

require 'optparse'
require 'open-uri'
require 'ldpath'
require 'lru_redux'

begin
  require 'rest-client'
rescue LoadError
end

options = {}
opt_parser = OptionParser.new do |opts|
  opts.banner = "Usage: ldpath [options] URI"

  opts.on("--program=STRING_URI_OR_FILE", "LDPath program to run") do |program|
    options[:program] = if File.exist?(program) || program =~ /^http/
                          open(program).read
                        else
                          program
                        end
  end
end

opt_parser.parse!

uris = ARGV
uris = ARGF if uris.empty? || uris.first == '-'


cache = LruRedux::TTL::Cache.new(1000, 120)
program = Ldpath::Program.parse(options[:program])

uris.each do |uri|
  puts program.evaluate(RDF::URI.new(uri.strip), cache: cache).to_json
end
